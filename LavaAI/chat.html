<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="LavaAI - Fast, configurable, multi-model AI chats">
    <title>LavaAI â€” Chat</title>
    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'><path fill='%23c084fc' d='M21 16.5c0 .38-.21.71-.53.88l-7.9 4.44c-.16.12-.36.18-.57.18-.21 0-.41-.06-.57-.18l-7.9-4.44A.991.991 0 0 1 3 16.5v-9c0-.38.21-.71.53-.88l7.9-4.44c.16-.12.36-.18.57-.18.21 0 .41.06.57.18l7.9 4.44c.32.17.53.5.53.88v9zM12 4.15L5.4 7.86l6.6 3.71 6.6-3.71L12 4.15zM4.5 9.1v6.52l6.5 3.66v-6.52L4.5 9.1zm15 6.52V9.1l-6.5 3.66v6.52l6.5-3.66z'/></svg>">
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=JetBrains+Mono&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="style.css">

    <!-- Marked.js for Markdown parsing -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <!-- DOMPurify for sanitizing marked output -->
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>

    <!-- Highlight.js for code syntax highlighting -->
    <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/tokyo-night-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
</head>

<body class="chat-body">
    <!-- Header -->
    <header class="chat-header">
        <div class="chat-header-left">
            <a href="index.html" class="back-btn" title="Back to Hub">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z" />
                </svg>
            </a>
            <input type="text" id="chatTitleInput" class="chat-title-input" value="Untitled Chat" autocomplete="off"
                oninput="saveCurrentChat()">
        </div>

        <div class="chat-header-center">
            <div class="model-selector-wrap">
                <select id="modelPresetSelect" class="model-select" onchange="handleModelChange()">
                    <option value="openai/gpt-oss-120b" selected>GPT OSS 120b</option>
                    <option value="x-ai/grok-4.1-fast">Grok 4.1 Fast</option>
                    <option value="anthropic/claude-sonnet-4.6">Claude Sonnet 4.6</option>
                    <option value="google/gemini-3-flash-preview">Gemini 3 Flash Preview</option>
                    <option value="custom">Custom ID...</option>
                </select>
                <!-- Rendered hidden if preset selected, shown if Custom chosen -->
                <input type="text" id="customModelInput" class="custom-model-input hidden"
                    placeholder="Enter OpenRouter Model ID" onchange="saveCurrentChat()">
            </div>

            <!-- Plugin Engine Entry -->
            <button class="btn btn-outline" id="btnPlugins" onclick="openPluginModal()"
                style="padding:6px 12px; font-size:0.85rem; border-color:rgba(192,132,252,0.3); color:#c084fc;">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="margin-right:4px;">
                    <path
                        d="M19.3 16.9c.4-.7.7-1.5.7-2.4 0-2.5-2-4.5-4.5-4.5-1.1 0-2.1.4-2.9 1l-6-6-2.8 2.8 5.4 5.4c-.6.8-1 1.9-1 3 0 2.5 2 4.5 4.5 4.5.9 0 1.7-.3 2.4-.7l4.1 4.1 2.8-2.8-2.7-2.7zM12.5 18c-1.4 0-2.5-1.1-2.5-2.5s1.1-2.5 2.5-2.5 2.5 1.1 2.5 2.5-1.1 2.5-2.5 2.5z" />
                </svg>
                Plugins
            </button>
        </div>
    </header>

    <!-- EXTENSION MARKETPLACE MODAL -->
    <div id="extensionMarketplaceOverlay" class="modal-overlay hidden">
        <div class="modal-box"
            style="max-width: 750px; padding: 0; display: flex; flex-direction: column; background: var(--bg); border: 1px solid rgba(192,132,252,0.3); box-shadow: 0 0 50px rgba(192,132,252,0.05); overflow: hidden; max-height: 85vh; border-radius: 16px;">

            <!-- Header -->
            <div
                style="padding: 1.5rem 2rem; border-bottom: 1px solid var(--border); background: var(--surface); display: flex; justify-content: space-between; align-items: center;">
                <div style="display: flex; align-items: center; gap: 12px;">
                    <div
                        style="width: 32px; height: 32px; border-radius: 8px; background: rgba(192,132,252,0.15); display: flex; align-items: center; justify-content: center; color: #c084fc;">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
                            <path
                                d="M19.3 16.9c.4-.7.7-1.5.7-2.4 0-2.5-2-4.5-4.5-4.5-1.1 0-2.1.4-2.9 1l-6-6-2.8 2.8 5.4 5.4c-.6.8-1 1.9-1 3 0 2.5 2 4.5 4.5 4.5.9 0 1.7-.3 2.4-.7l4.1 4.1 2.8-2.8-2.7-2.7zM12.5 18c-1.4 0-2.5-1.1-2.5-2.5s1.1-2.5 2.5-2.5 2.5 1.1 2.5 2.5-1.1 2.5-2.5 2.5z" />
                        </svg>
                    </div>
                    <div>
                        <h2 style="margin: 0; font-size: 1.25rem; color: #fff; letter-spacing: -0.02em;">Extension
                            Marketplace</h2>
                        <div style="font-size: 0.75rem; color: var(--muted); margin-top: 2px;">Customize LavaAI with
                            modular architecture</div>
                    </div>
                </div>
                <button onclick="closeExtModal()"
                    style="background: none; border: none; color: var(--muted); font-size: 1.5rem; cursor: pointer; padding: 4px; line-height: 1;">&times;</button>
            </div>

            <div style="display: flex; flex: 1; overflow: hidden; position: relative;">

                <!-- MARKETPLACE HOME VIEW -->
                <div id="extMarketHome" style="flex: 1; padding: 2rem; overflow-y: auto; background: var(--bg);">

                    <div class="ext-grid" style="display: flex; flex-direction: column; gap: 1rem;">

                        <!-- Memory Compression -->
                        <div class="ext-card" id="ext-Memory" data-id="memoryCompress">
                            <div class="ext-icon" style="background: rgba(6,182,212,0.1); color: #06b6d4;">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                                    <path
                                        d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z" />
                                </svg>
                            </div>
                            <div class="ext-info">
                                <div class="ext-header">
                                    <h3>Memory Compression</h3>
                                    <span class="ext-status" id="status-Memory">Not Installed</span>
                                </div>
                                <p>Automatically slices and summarizes conversation history to save tokens.</p>
                            </div>
                            <div class="ext-actions" id="actions-Memory">
                                <!-- injected via JS -->
                            </div>
                        </div>

                        <!-- Personality Manager -->
                        <div class="ext-card" id="ext-Personality" data-id="personality">
                            <div class="ext-icon" style="background: rgba(192,132,252,0.1); color: #c084fc;">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                                    <path
                                        d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z" />
                                </svg>
                            </div>
                            <div class="ext-info">
                                <div class="ext-header">
                                    <h3>PersonalityManager</h3>
                                    <span class="ext-status" id="status-Personality">Not Installed</span>
                                </div>
                                <p>Control the core identity, tone, and temperature of the AI natively.</p>
                            </div>
                            <div class="ext-actions" id="actions-Personality"></div>
                        </div>

                        <!-- PromptMagic -->
                        <div class="ext-card" id="ext-PromptMagic" data-id="promptMagic">
                            <div class="ext-icon" style="background: rgba(236,72,153,0.1); color: #ec4899;">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                                    <path
                                        d="M7.5 5.6L5 7l1.4-2.5L5 2l2.5 1.4L10 2 8.6 4.5 10 7 7.5 5.6zm12 9.8L17 14l1.4 2.5L17 19l2.5-1.4L22 19l-1.4-2.5L22 14l-2.5 1.4zM22 2l-2.5 1.4L17 2l1.4 2.5L17 7l2.5-1.4L22 7l-1.4-2.5L22 2zm-7.63 5.29c-.39-.39-1.02-.39-1.41 0L1.29 18.96c-.39.39-.39 1.02 0 1.41l2.34 2.34c.39.39 1.02.39 1.41 0L16.71 11.04c.39-.39.39-1.02 0-1.41l-2.34-2.34z" />
                                </svg>
                            </div>
                            <div class="ext-info">
                                <div class="ext-header">
                                    <h3>PromptMagic</h3>
                                    <span class="ext-status" id="status-PromptMagic">Not Installed</span>
                                </div>
                                <p>Injects persistent custom instructions arbitrarily underneath the Core Behavior.</p>
                            </div>
                            <div class="ext-actions" id="actions-PromptMagic"></div>
                        </div>

                        <!-- Developer Stats -->
                        <div class="ext-card" id="ext-DevStats" data-id="devStats">
                            <div class="ext-icon" style="background: rgba(245,158,11,0.1); color: #f59e0b;">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                                    <path
                                        d="M22.7 19l-9.1-9.1c.9-2.3.4-5-1.5-6.9-2-2-5-2.4-7.4-1.1L9 6 6 9 1.8 4.7c-1.3 2.4-.9 5.4 1.1 7.4 1.9 1.9 4.6 2.4 6.9 1.5l9.1 9.1c.4.4 1 .4 1.4 0l2.4-2.4c.4-.4.4-1 0-1.3z" />
                                </svg>
                            </div>
                            <div class="ext-info">
                                <div class="ext-header">
                                    <h3>Developer Stats</h3>
                                    <span class="ext-status" id="status-DevStats">Not Installed</span>
                                </div>
                                <p>Exposes raw token usage, latency, UI-cost estimates and TPS metrics beneath every
                                    message.</p>
                            </div>
                            <div class="ext-actions" id="actions-DevStats"></div>
                        </div>

                        <!-- HTMLVIEW -->
                        <div class="ext-card" id="ext-HtmlView" data-id="htmlView">
                            <div class="ext-icon" style="background: rgba(16,185,129,0.1); color: #10b981;">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                                    <path
                                        d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 14.5v-9l6 4.5-6 4.5z" />
                                </svg>
                            </div>
                            <div class="ext-info">
                                <div class="ext-header">
                                    <h3>HTMLVIEW</h3>
                                    <span class="ext-status" id="status-HtmlView">Not Installed</span>
                                </div>
                                <p>Automatically detect HTML code blocks, attaching native rendering canvases and Copy
                                    utilities.</p>
                            </div>
                            <div class="ext-actions" id="actions-HtmlView"></div>
                        </div>

                        <!-- I.WANT.MORE. -->
                        <div class="ext-card" id="ext-IWantMore" data-id="iWantMore">
                            <div class="ext-icon" style="background: rgba(59,130,246,0.1); color: #3b82f6;">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z" />
                                </svg>
                            </div>
                            <div class="ext-info">
                                <div class="ext-header">
                                    <h3>I. WANT. MORE.</h3>
                                    <span class="ext-status" id="status-IWantMore">Not Installed</span>
                                </div>
                                <p>Unlock deep message actions! Adds Copy, Regenerate, and Edit features to AI
                                    responses.</p>
                            </div>
                            <div class="ext-actions" id="actions-IWantMore"></div>
                        </div>

                        <!-- Purson -->
                        <div class="ext-card" id="ext-Purson" data-id="purson">
                            <div class="ext-icon" style="background: rgba(239,68,68,0.1); color: #ef4444;">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                                    <path
                                        d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z" />
                                </svg>
                            </div>
                            <div class="ext-info">
                                <div class="ext-header">
                                    <h3>Purson (Personalizer)</h3>
                                    <span class="ext-status" id="status-Purson">Not Installed</span>
                                </div>
                                <p>Silently coerces the AI to be highly empathetic, open, free, and dramatically
                                    human-like in tone.</p>
                            </div>
                            <div class="ext-actions" id="actions-Purson"></div>
                        </div>

                        <!-- Formato -->
                        <div class="ext-card" id="ext-Formato" data-id="formato">
                            <div class="ext-icon" style="background: rgba(245,158,11,0.1); color: #f59e0b;">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                                    <path
                                        d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z" />
                                </svg>
                            </div>
                            <div class="ext-info">
                                <div class="ext-header">
                                    <h3>Formato Layer</h3>
                                    <span class="ext-status" id="status-Formato">Not Installed</span>
                                </div>
                                <p>Force structural layouts, JSON boundaries, and advanced markdown parsing logic.</p>
                            </div>
                            <div class="ext-actions" id="actions-Formato"></div>
                        </div>

                        <!-- End of Extensions -->
                    </div>

                </div>
            </div>

            <!-- EXTENSION CONFIG VIEW (Slide Over) -->
            <div id="extConfigView"
                style="position: absolute; inset: 0; background: var(--bg); display: flex; flex-direction: column; transform: translateX(100%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); z-index: 10;">

                <div
                    style="padding: 1rem 2rem; border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 12px; background: var(--surface);">
                    <button onclick="closeExtConfig()" class="btn-outline"
                        style="padding: 6px; border:none; display:flex; align-items:center;">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z" />
                        </svg>
                    </button>
                    <h3 id="extConfigTitle" style="margin: 0; font-size: 1.1rem; color: #fff;">Extension Settings
                    </h3>
                </div>

                <div style="flex: 1; overflow-y: auto; padding: 2rem;">

                    <!-- Top Level Toggles -->
                    <div
                        style="display: flex; flex-direction: column; gap: 12px; margin-bottom: 2rem; padding: 1.5rem; background: var(--surface); border: 1px solid var(--border); border-radius: 12px;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div style="font-weight: 600;">Enable in Current Chat</div>
                                <div style="font-size: 0.8rem; color: var(--muted);">Turn this extension on/off for
                                    the active session.</div>
                            </div>
                            <label class="switch"><input type="checkbox" id="extToggleCurrent"><span
                                    class="slider round"></span></label>
                        </div>
                        <div style="height: 1px; background: var(--border); margin: 8px 0;"></div>
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div style="font-weight: 600;">Enable by Default</div>
                                <div style="font-size: 0.8rem; color: var(--muted);">Automatically enable for newly
                                    created chats.</div>
                            </div>
                            <label class="switch"><input type="checkbox" id="extToggleDefault"><span
                                    class="slider round"></span></label>
                        </div>
                    </div>

                    <!-- Dynamic Payload Area -->
                    <div id="extConfigBody" style="display: flex; flex-direction: column; gap: 1.5rem;">
                        <!-- Forms injected via JS depending on extension -->
                    </div>

                </div>

                <div
                    style="padding: 1rem 2rem; border-top: 1px solid var(--border); background: var(--surface); display: flex; justify-content: flex-end;">
                    <button class="btn btn-primary" onclick="saveExtConfig()">Save Configuration</button>
                </div>
            </div>

        </div>
    </div>
    </div>

    <!-- Main Chat View Area -->
    <main class="chat-viewport" id="chatViewport">
        <div class="chat-messages" id="chatMessages">
            <!-- Messages inserted here via JS -->
        </div>
    </main>

    <!-- Input Area -->
    <div class="chat-input-container">
        <!-- Attachment Previews -->
        <div id="attachmentPreviews" class="attachment-previews hidden"></div>

        <div class="chat-input-wrapper">
            <button class="btn-attach" onclick="document.getElementById('fileUpload').click()" title="Attach Images">
                <svg width="22" height="22" viewBox="0 0 24 24" fill="currentColor">
                    <path
                        d="M16.5 6v11.5c0 2.21-1.79 4-4 4s-4-1.79-4-4V5a2.5 2.5 0 0 1 5 0v10.5c0 .55-.45 1-1 1s-1-.45-1-1V6H10v9.5a2.5 2.5 0 0 0 5 0V5c0-1.93-1.57-3.5-3.5-3.5S8 3.07 8 5v12.5c0 3.04 2.46 5.5 5.5 5.5s5.5-2.46 5.5-5.5V6h-1.5z" />
                </svg>
            </button>
            <input type="file" id="fileUpload" class="hidden" multiple accept="image/*"
                onchange="handleFileUpload(event)">

            <textarea id="promptInput" class="prompt-input" rows="1" placeholder="Type a message..."
                oninput="autoResize(this)" onkeydown="handleEnter(event)"></textarea>

            <button class="btn-send" id="btnSend" onclick="sendMessage()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z" />
                </svg>
            </button>
        </div>
        <div class="chat-footer-info">Tokens are estimated locally. AI can make mistakes. Check important info.</div>
    </div>

    <script src="../shared_modal.js"></script>
    <script src="chat.js"></script>
</body>

</html>